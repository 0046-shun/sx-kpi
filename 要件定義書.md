# 日報・月報作成システム 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト名
日報・月報作成システム

### 1.2 目的
- 既存の受注管理表（◆2024年度確認表◆.xlsx）のデータを活用
- 効率的な日報・月報の作成・管理
- 業務の可視化と進捗管理の向上

### 1.3 対象ユーザー
- 営業担当者
- 管理者
- 事務担当者

## 2. システム概要

### 2.1 システム構成
- フロントエンド（Webアプリケーション）
- バックエンド（データ処理・API）
- データベース（受注データ管理）

### 2.2 主要機能
- 日報作成・編集・管理
- 月報作成・編集・管理
- 受注データの抽出・分析
- レポート出力（PDF、Excel等）

## 3. 機能要件

### 3.1 日報機能
- [ ] 日報の作成・編集
- [ ] 日報テンプレートの管理
- [ ] 日報の保存・検索
- [x] 日報項目の自動集計
  - 総受注件数
  - 総時間外対応件数（18:30以降）
  - 地区別受注件数
    - 契約者高齢者（70歳以上）件数
      - 内①過量販売件数
      - 内②単独契約件数
    - 契約者通常年齢（69歳以下）件数
      - 内①過量販売件数
    - 法人契約件数（H列がハイフンの場合）
  - 地区別時間外対応件数（18:30以降対応件数）
- [ ] エビデンス参照機能

### 3.2 月報機能
- [ ] 月報の作成・編集
- [ ] 月報テンプレートの管理
- [ ] 月報の保存・検索
- [x] 月報項目の自動集計（日報と同項目）
- [x] 担当者別ランキング集計
  - 契約者70歳以上の受注件数トップ10ランキング
  - 単独契約ランキング（1件以上）
  - 過量販売ランキング（1件以上）
  - 69歳以下契約件数の担当別件数（全担当者）
  - 法人契約件数の担当別件数（全担当者）
- [ ] エビデンス参照機能

### 3.3 データ連携機能
- [ ] Excelファイルからのデータ読み込み
- [ ] Excelファイルのドラッグ&ドロップ対応
- [ ] 受注データの自動抽出・集計
- [ ] 日報・月報項目の自動計算
- [ ] データの更新・同期

### 3.4 レポート機能
- [ ] 各種レポートの生成
- [ ] レポートの出力・配布
- [ ] レポートテンプレートの管理
- [x] PDF形式での出力
- [x] CSV形式での出力
- [x] 担当者別ランキングCSV出力（個別ファイル）
- [ ] 出力形式の選択機能

## 4. 非機能要件

### 4.1 性能要件
- レスポンス時間：3秒以内
- 同時接続数：50ユーザー
- データ処理速度：1000件/分

### 4.2 可用性要件
- 稼働率：99.5%以上
- 保守時間：月1回、2時間以内

### 4.3 セキュリティ要件
- [x] ローカル環境での使用（認証不要）
- [ ] データの暗号化
- [ ] アクセスログの記録

## 5. 技術要件

### 5.1 開発環境
- プログラミング言語：TypeScript
- フレームワーク：なし（Vanilla JS）
- フロントエンド：HTML5, CSS3, Bootstrap
- データベース：ローカルストレージ（IndexedDB）
- その他ツール：Excel.js（Excelファイル読み込み）

### 5.2 運用環境
- OS：Windows 10/11
- Webサーバー：ローカルファイル（file://）
- データベースサーバー：なし（ブラウザ内蔵）
- その他：Chrome/Firefox/Edge等のモダンブラウザ

## 6. データ要件

### 6.1 入力データ
- 受注管理表（Excel）
  - ドラッグ&ドロップ対応
  - 自動データ読み込み
- ユーザー入力データ
- システム設定データ

### 6.2 出力データ
- 日報データ
- 月報データ
- 各種レポートデータ
- PDF形式での出力
- CSV形式での出力

### 6.3 データ構造
- 受注データの詳細設計
  - 日付（A列）
  - 時間（B列）
  - 地区№（C列）
  - 契約者情報（F～I列）
  - 確認者情報（J～O列）
  - その他業務データ（P～AE列）
- K列のデータ構造と判定ロジック
  - 通常パターン：「8/20 12:37 大城」（日付+時間+担当者名）
  - 特殊パターン：「同時」（A列+B列の日付時間を参照）
  - 除外パターン：「担当待ち」「直電」「契約時」「契約」「待ち」（アクション未実施のためカウント対象外）
- 除外パターン例：「8/20 19:30 担当待ち」「直電」「契約時」「契約」「待ち」
- アクション実施判定
  - K列に「担当待ち」「直電」「契約時」「契約」「待ち」が含まれる場合：アクション未実施（カウント対象外）
  - K列が「同時」の場合：A列+B列の日付時間でアクション実施済み
  - K列が「日付+時間+担当者名」の3要素の場合：アクション実施済み
- 受注の定義
  - 契約者及び確認者の挨拶（アクション）が済んでいる案件のみが受注
  - A列の日付が存在していても、確認者の挨拶（アクション）が済んでいないと受注件数にカウントされない
  - J列の確認区分の数値が空欄または4のもののみが受注対象
  - J列の確認区分が1の場合は未アクションや契約日の後追いの必要がある案件（カウント対象外）
  - J列の確認区分が2の場合はキャンセル案件（カウント対象外）
  - J列の確認区分が5の場合は受注対象外（カウント対象外）
- 日報・月報データの詳細設計
  - 総受注件数（受注定義を満たす案件のみ）
  - 総時間外対応件数（18:30以降、受注定義を満たす案件のみ）
  - 地区別受注件数（受注定義を満たす案件のみ）
    - 契約者高齢者（70歳以上）件数
      - 過量販売件数（K列に「過量」文言含む、受注定義を満たす案件のみ）
      - 単独契約件数（K列に「単独」文言含む、受注定義を満たす案件のみ）
    - 契約者通常年齢（69歳以下）件数
      - 過量販売件数（K列に「過量」文言含む、受注定義を満たす案件のみ）
    - 法人契約件数（H列がハイフンの場合、受注定義を満たす案件のみ）
  - 地区別時間外対応件数（18:30以降対応件数、受注定義を満たす案件のみ）
- 地区分類マスタ
  - 511：九州地区
  - 521+531：中四国地区（合算）
  - 541：関西地区
  - 561：関東地区
- 時間外対応判定
  - K列が「同時」の場合：A列（日付）+ B列（時間）が18:30以降
  - K列が「日付+時間+担当者名」の場合：K列の時間が18:30以降
  - 「担当待ち」「直電」「契約時」「契約」「待ち」を含む場合は判定対象外
- マスタデータの詳細設計

## 7. 画面要件

### 7.1 画面一覧
- [x] メイン画面
- [ ] 日報作成画面
- [ ] 月報作成画面
- [ ] データ管理画面
- [ ] Excelファイルアップロード画面
- [ ] レポート出力画面
- [ ] 設定画面

### 7.2 画面詳細設計
- 各画面のレイアウト
- 入力項目の詳細
- バリデーションルール

## 8. 移行要件

### 8.1 データ移行
- 既存Excelデータの移行
- データの整合性確認
- 移行後の動作確認
- 日報作成頻度：毎日
- データ更新：ユーザーのタイミング（自動化なし）

### 8.2 ユーザー移行
- ユーザーアカウントの移行
- 権限設定の移行
- ユーザー教育・研修

## 9. 運用要件

### 9.1 運用体制
- システム管理者
- ヘルプデスク
- 運用マニュアル

### 9.2 保守・運用
- 定期保守の実施
- 障害対応体制
- パフォーマンス監視

## 10. 今後の検討事項

### 10.1 詳細設計項目
- [x] 日報・月報の具体的な項目
  - 総受注件数
  - 総時間外対応件数（18:30以降）
  - 地区別受注件数
    - 契約者高齢者（70歳以上）件数
      - 内①過量販売件数
      - 内②単独契約件数
    - 契約者通常年齢（69歳以下）件数
      - 内①過量販売件数
    - 法人契約件数（H列がハイフンの場合）
  - 地区別時間外対応件数（18:30以降対応件数）
- [x] 担当者別ランキング集計
  - 契約者70歳以上の受注件数トップ10ランキング
  - 単独契約ランキング（1件以上）
  - 過量販売ランキング（1件以上）
  - 69歳以下契約件数の担当別件数（全担当者）
  - 法人契約件数の担当別件数（全担当者）
- [ ] 承認フローの詳細
- [ ] レポートテンプレートの詳細
- [ ] データ抽出・集計の詳細
- [x] Excelファイルドラッグ&ドロップ機能
- [x] PDF・CSV出力機能
- [x] 担当者別ランキングCSV出力（個別ファイル）

### 10.2 質問項目
- [x] 日報に含めるべき項目
- [x] 月報に含めるべき項目
- [x] 承認フローの流れ（エビデンス参照のみ）
- [x] レポート出力形式（PDF・CSV）
- [x] データ更新頻度（毎日、ユーザータイミング）
- [x] ユーザー権限の詳細（ローカル使用、権限不要）
- [x] 過量販売の判定基準（K列に「過量」文言含む）
- [x] 単独契約の判定基準（K列に「単独」文言含む）
- [x] 時間外対応の詳細時間設定（18:30以降）
- [x] 地区別集計の詳細ルール（521+531=中四国地区）
- [x] 技術スタック（TypeScript + HTML + CSS + Bootstrap）

---

**作成日**: 2024年12月
**作成者**: 
**バージョン**: 1.0
**ステータス**: 初期版（詳細検討中）

## 11. 修正履歴

### 11.1 2025年1月の重要修正

#### 受注件数カウント問題の修正
- **問題**: 8/20の受注件数が47件（期待値52件）
- **原因**: `isOrder`関数内で日付判定が8/20固定になっていた
- **修正**: `excel-processor.ts`の`isOrder`関数を動的日付判定に変更
- **結果**: 8/20の受注件数が52件に修正

#### 時間外カウント問題の修正
- **問題**: どの日付でも時間外件数が0件
- **原因**: `isOvertime`関数内で`isOrder`チェックが8/20固定になっていた
- **修正**: `excel-processor.ts`の`isOvertime`から`isOrder`チェックを削除
- **結果**: 各日付で正確な時間外件数が表示されるように修正

#### 時間外判定ロジックの強化
- **問題**: K列の時間解析が不完全で、18:30以降の時間外が正しく判定されない
- **原因**: 正規表現による時間パターンマッチングが不十分
- **修正**: K列の時間解析を強化（正規表現 + 従来方法の併用）
- **結果**: "8/19　18：44　柚木"のような形式で18:30以降が正しく時間外として判定される

#### 契約者・確認者別時間外判定の実装
- **問題**: 優先順位方式でK列に時間があるとA列+B列が無視される（期待値11件→実際6件）
- **原因**: `isOvertime`関数が優先順位で一つの時間のみを判定
- **修正**: 契約者（A列+B列）と確認者（K列）を別々に判定し、いずれかが時間外なら時間外とする
- **結果**: A列+B列の6件 + K列の5件 = 11件の時間外が正しく判定される

#### 月選択UIの修正
- **問題**: 月選択を変更しても月報タイトルが8月のまま
- **原因**: `createMonthlyReportHTML`で`new Date()`（現在日付）を使用
- **修正**: 選択された月（`report.selectedMonth`）を使用するように変更
- **結果**: 月選択に応じて月報タイトルが動的に更新される

#### 月変更イベントの実装
- **追加機能**: 月選択変更時に月報データを自動更新
- **実装**: `handleMonthChange()`メソッドと`generateMonthlyReportOnly()`メソッドを追加
- **結果**: 月選択変更時に月報が自動的に再生成される

### 11.2 2025年1月の重要修正（日報・月報判定ロジック分離）

#### 「遅い日付」ロジックの実装
- **問題**: A列（受注日）とK列（確認日時）の日付を比較して、遅い日付でカウントする必要がある
- **要件**: 月報でも同様のロジックを適用（A列7月/K列8月であれば8月にカウント）
- **実装**: `excel-processor.ts`の`isOrderForDate`メソッドで`effectiveDate`を導入
- **結果**: 受注日と確認日時を比較して、遅い日付を採用するロジックが実装された

#### 日報・月報の判定ロジック分離
- **問題**: 日報生成時に月報判定が実行され、正しくないデータが含まれる
- **原因**: `isOrderForDate`メソッドで日報判定失敗時に月報判定が実行される
- **修正**: `isOrderForDate`メソッドに第3パラメータ`isDailyReport`を追加
  - `true`: 日報生成時（日付一致のみ判定）
  - `false`: 月報生成時（日付一致 + 月報判定）
- **結果**: 日報と月報で適切な判定ロジックが分離された

#### 担当別データの重複更新問題の解決
- **問題**: 日報・月報生成時に担当別データが複数回更新され、異なるtargetDateで処理される
- **原因**: `displayReport`内と`generateMonthlyReport`内で両方とも担当別データ更新が実行される
- **修正**: `app.ts`の`displayReport`メソッドで担当別データ更新を無効化
- **結果**: 日報生成時は担当別データ更新なし、月報生成時のみ`updateStaffDataWithMonthlyData`で更新

#### デバッグログの削除とローディング表示の追加
- **デバッグログ**: 本番環境用に`isOrderForDate`メソッドから全ての`console.log`を削除
- **ローディング表示**: 日報・月報生成時にスピナーとメッセージで処理中であることを表示
- **結果**: 本番環境用のクリーンアップとユーザー体験の向上が実現された

### 11.3 技術的な重要なポイント

#### データ処理の流れの最適化
- **日報生成**: `isOrderForDate(row, targetDate, true)` → 日付一致のみ判定
- **月報生成**: `isOrderForDate(row, targetDate, false)` → 日付一致 + 月報判定
- **担当別データ更新**: 月報生成時のみ実行、日報時は更新なし

#### パフォーマンスの改善
- 重複処理の排除により、同じデータが異なるtargetDateで処理されることがなくなった
- 日報・月報生成時の処理時間が短縮された

#### 保守性の向上
- 日報・月報の判定ロジックが明確に分離され、今後の修正が容易になった
- デバッグログの削除により、本番環境での動作が安定した

### 11.4 2025年1月 - BIツール担当別ランキング修正

#### 担当者名正規化ロジックの統一
- **問題**: BIツールの担当別ランキングで担当者名が分散して集計される
- **原因**: 担当別タブでは`normalizeStaffName`で正規化しているが、BIツールでは`row.staffName`をそのまま使用
- **具体例**: 
  - "山下(弓弦)"と"山下"が別々の担当者として集計される
  - "山田(SE)"と"山田"が別々の担当者として集計される
- **修正**: BIツールに`normalizeStaffName`メソッドを追加し、担当別タブと同じ正規化ロジックを適用
- **正規化ルール**: 括弧（半角・全角）で囲まれた部分を除去
  - 例: "山下(弓弦)" → "山下"
  - 例: "山田(SE)" → "山田"
  - 例: "山田（技術）" → "山田"
- **結果**: BIツールの担当別ランキングが担当別タブと同じロジックで正確に集計される

#### 複合キー集計ロジックの追加修正
- **問題**: BIツールで地区・所属を考慮せずに担当者名だけで集計していた
- **具体例**: "511|5|中村"と"511|55|中村"が同一人物として集計される
- **原因**: 担当者名のみで集計していたため、同じ苗字でも別の営業担当者が混同される
- **修正**: BIツールでも複合キー（地区№|所属№|担当者名）を使用するように変更
- **複合キー形式**: `${row.regionNumber}|${row.departmentNumber}|${normalizedStaffName}`
- **ランキング表示**: 複合キーから担当者名を抽出して表示（地区・所属情報は非表示）
- **結果**: 地区・所属が異なる同じ苗字の担当者が正しく区別されて集計される

#### システム全体での担当者名処理の統一
- **担当別タブ**: `normalizeStaffName`で正規化 → 複合キー（地区№+所属№+担当者名）で集計
- **BIツール**: `normalizeStaffName`で正規化 → 複合キー（地区№|所属№|担当者名）で集計
- **一貫性の確保**: 両システムで同じ正規化ロジックと複合キー集計を使用することで、データの整合性が向上