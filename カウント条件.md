# 日報・月報システム 各項目のカウント条件

## 1. 受注件数のカウント条件

### 基本条件
- **J列の確認区分**: 1、2、5以外（空欄、3、4、6以上など）
- **A列の日付**: 該当日付が存在する
- **K列の内容**: 以下のいずれかの条件を満たす

### K列の詳細条件

#### 1. 「同時」の場合
- **条件**: K列 = "同時"
- **判定**: 有効（受注としてカウント）

#### 2. 契約者が69歳以下の場合
- **条件**: G列の年齢 ≤ 69歳
- **K列の条件**: 
  - 空欄
  - "過量"が含まれている
- **判定**: 有効（受注としてカウント）

#### 3. 日付+時間+担当者名の形式
- **条件**: K列が "8/20 12:37 大城" のような形式
- **日付一致**: K列の日付（8/20）とA列の日付が一致
- **判定**: 日付が一致する場合のみ有効

### 除外条件
- **J列の確認区分**: 1、2、5
- **K列のノーアクションキーワード**: "担当待ち"、"直電"、"契約時"、"契約"、"待ち"
- **A列の日付**: 存在しない
- **K列**: 空欄または不正な形式

## 2. 時間外対応件数のカウント条件

### 基本条件
- **受注条件**: 上記の受注件数条件を満たす
- **時間条件**: 18:30以降

### 時間判定の優先順位

#### 1. K列が「同時」の場合
- **使用時間**: A列+B列の日付時間
- **判定**: 18:30以降かチェック

#### 2. K列に日付+時間が含まれる場合
- **使用時間**: K列の時間（12:37など）
- **判定**: 18:30以降かチェック

#### 3. K列に時間情報がない場合
- **使用時間**: A列+B列の時間
- **判定**: 18:30以降かチェック

### 除外条件
- 受注条件を満たさない案件
- 18:30未満の案件

## 3. 地区別受注件数のカウント条件

### 基本条件
- 受注件数のカウント条件を満たす
- C列の地区№に基づく分類

### 地区分類
- **511**: 九州地区
- **521 + 531**: 中四国地区（合算）
- **541**: 関西地区
- **561**: 関東地区
- **その他**: 上記以外の地区№

## 4. 年齢別集計のカウント条件

### 契約者高齢者（70歳以上）
- **基本条件**: 受注件数のカウント条件を満たす
- **年齢条件**: G列の年齢 ≥ 70歳

#### 過量販売件数
- **追加条件**: K列に"過量"が含まれている

#### 単独契約件数
- **追加条件**: K列に"単独"が含まれている

### 契約者通常年齢（69歳以下）
- **基本条件**: 受注件数のカウント条件を満たす
- **年齢条件**: G列の年齢 ≤ 69歳

#### 過量販売件数
- **追加条件**: K列に"過量"が含まれている

## 5. 地区別時間外対応件数のカウント条件

### 基本条件
- 時間外対応件数のカウント条件を満たす
- 地区別受注件数の地区分類に従う

## 6. 公休日・禁止日施工の集計ロジック

### 集計の流れ
受注1件に対し、以下の優先順位で公休日施工または禁止日施工を判定し、カウントします。

#### 1. T列（着工日）の判定
- **T列の着工日**が公休日または禁止日に該当する場合、その受注は「公休日施工」または「禁止日施工」として**カウント**されます。
- この時点でカウントされた場合、V列の判定は行われません。

#### 2. V列（完工予定日）の判定
- **T列の着工日**でカウントされなかった受注についてのみ、V列の完工予定日を判定します。
- **V列の完工予定日**が公休日または禁止日に該当する場合、その受注は「公休日施工」または「禁止日施工」として**カウント**されます。

### 補足事項
- **契約日（S列）**は公休日・禁止日施工の集計対象外です。
- **T列でカウントされた場合**はV列の照合は除外されます。
- この集計は、受注件数のカウント条件を満たす案件のみを対象とします。

## 7. 担当者別ランキング集計のカウント条件

### 基本条件
- 受注件数のカウント条件を満たす案件のみ対象
- 対象月のデータ（例：8月選択時は8/1〜8/31）
- 担当者の識別：所属№ + 担当者名の組み合わせ

### 7.1 契約者70歳以上の受注件数トップ10ランキング
- **対象**: G列の年齢 ≥ 70歳
- **集計単位**: 所属№ + 担当者名
- **表示**: 1位〜10位（同件数は同順位、次の順位は飛ばす）
- **列**: ランキング｜地区No.｜所属No.｜担当名｜件数

### 7.2 単独契約ランキング
- **対象**: K列に"単独"が含まれる案件
- **集計単位**: 所属№ + 担当者名
- **表示**: 1件以上から最大件数の担当者まで
- **列**: ランキング｜地区No.｜所属No.｜担当名｜件数

### 7.3 過量販売ランキング
- **対象**: K列に"過量"が含まれる案件
- **集計単位**: 所属№ + 担当者名
- **表示**: 1件以上から最大件数の担当者まで
- **列**: ランキング｜地区No.｜所属No.｜担当名｜件数

### 7.4 69歳以下契約件数の担当別件数
- **対象**: G列の年齢 ≤ 69歳
- **集計単位**: 所属№ + 担当者名
- **表示**: 全担当者（0件含む）を件数降順
- **列**: ランキング｜地区No.｜所属No.｜担当名｜件数

### 7.5 出力対象
- **PDF**: ①②③のみ
- **CSV**: ①②③④全て、番号ごとに個別CSV化

## 8. データ処理の流れ

### 1. データ読み込み
- Excelファイルの9行目以降をデータとして読み込み
- 各行をオブジェクトに変換

### 2. 受注判定
- `isOrder`メソッドで受注条件をチェック
- J列、A列、K列、G列の条件を順次確認

### 3. 時間外判定
- `isOvertime`メソッドで時間外条件をチェック
- 受注条件を満たす案件のみ対象

### 4. フィルタリング
- 受注条件を満たす行のみを抽出
- 日付が存在し、`isOrder = true`の行

### 5. 集計処理
- フィルタリングされたデータで各項目を集計
- 地区別、年齢別、時間外別の分類

## 7. デバッグ・テスト用の条件

### コンソールログ出力
- 各行のデータ読み込み状況
- `isOrder`の判定過程
- `isOvertime`の判定過程
- フィルタリング結果

### テスト用の一時的な条件無効化
- J列の条件チェックを一時的に無効化
- 問題の根本原因を特定

## 8. 注意事項

### データの型変換
- J列の確認区分: 文字列→数値変換で比較
- 日付形式: Excel形式→JavaScript Date形式
- 時間形式: Excel形式→HH:MM形式

## 9. 担当者別ランキング集計の実装

### 9.1 2025年1月の新機能追加

#### 担当者別ランキング集計機能
- **新機能**: 月報作成時の担当者別ランキング表示
- **対象**: 契約者70歳以上、単独契約、過量販売、69歳以下契約
- **識別方法**: 所属№ + 担当者名の組み合わせ
- **ランキング方式**: 同件数は同順位、次の順位は飛ばす
- **出力形式**: PDF（①②③）、CSV（①②③④個別ファイル）

## 10. 修正履歴

### 9.1 2025年1月の重要修正

#### 受注件数カウント問題
- **修正前**: `isOrder`関数で日付判定が8/20固定
- **修正後**: 動的日付判定（UI選択日付に応じて変更）
- **影響**: 各日付で正確な受注件数が表示される

#### 時間外カウント問題
- **修正前**: `isOvertime`関数内で`isOrder`チェックが8/20固定
- **修正後**: `isOvertime`から`isOrder`チェックを削除
- **影響**: 各日付で正確な時間外件数が表示される

#### 時間外判定ロジックの強化
- **修正前**: K列の時間解析が不完全（"8/19　18：44　柚木"の18:44が判定されない）
- **修正後**: 正規表現による時間パターンマッチングを強化
- **影響**: K列の18:30以降の時間が正しく時間外として判定される

#### 契約者・確認者別時間外判定の実装
- **修正前**: 優先順位方式（K列優先、A列+B列は補完のみ）
- **修正後**: 契約者（A列+B列）と確認者（K列）を独立して判定
- **影響**: 両方の時間外が正しくカウントされる（8/19: 6件+5件=11件）

#### 月選択UI問題
- **修正前**: 月報タイトルが常に現在月（8月）表示
- **修正後**: 選択された月を動的に表示
- **影響**: 月選択に応じて月報タイトルが更新される

### エラーハンドリング
- 不正なデータ形式の処理
- 空セルの処理
- 型変換エラーの処理

### パフォーマンス
- 大量データ処理時の最適化
- メモリ使用量の管理
- 処理時間の監視
