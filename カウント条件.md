# 日報・月報システム カウント条件仕様書

## 1. 受注件数のカウント条件

### 基本条件
受注として認められるためには、以下のすべての条件を満たす必要があります：

1. **J列（確認区分）**: 1、2、5以外（空欄、3、4、6以上など）
2. **A列（日付）**: 有効な日付が存在する
3. **K列（確認者日時）**: 以下のいずれかの条件を満たす

### K列の詳細判定条件

#### パターン1: 「同時」の場合
- **条件**: K列 = "同時"
- **判定**: 有効（受注としてカウント）

#### パターン2: 契約者が69歳以下の場合
- **年齢条件**: G列の年齢 ≤ 69歳
- **K列条件**: 
  - 空欄である
  - または「過量」が含まれている
- **判定**: 有効（受注としてカウント）

#### パターン3: 日付+時間+担当者名の形式
- **条件**: K列が "8/20 12:37 大城" のような形式
- **日付照合**: K列の日付とA列の日付が一致
- **判定**: 日付が一致する場合のみ有効

### 除外条件
以下の条件に該当する場合は受注としてカウントされません：

- J列の確認区分が1、2、5のいずれか
- K列に除外キーワードが含まれる：「担当待ち」「直電」「契約時」「契約」「待ち」
- A列に有効な日付が存在しない

## 2. 時間外対応件数のカウント条件

### 基本条件
- 受注件数の条件を満たす案件のみが対象
- 判定時刻が18:30以降である

### 時間判定の優先順位

#### 優先度1: K列が「同時」の場合
- **使用時刻**: A列（日付）+ B列（時間）
- **判定**: 18:30以降かチェック

#### 優先度2: K列に時間情報が含まれる場合
- **パターン**: "XX:XX" または "XX：XX" の形式
- **使用時刻**: K列から抽出した時間
- **判定**: 18:30以降かチェック

#### 優先度3: その他の場合
- **使用時刻**: A列（日付）+ B列（時間）
- **判定**: 18:30以降かチェック

## 3. 地区別集計

### 地区分類
- **511**: 九州地区
- **521 + 531**: 中四国地区（合算）
- **541**: 関西地区
- **561**: 関東地区
- **その他**: 上記以外の地区№

### 集計項目
各地区ごとに以下を集計：
- 受注件数
- 時間外対応件数
- 過量販売件数
- 単独契約件数
- 公休日施工件数
- 禁止日施工件数

## 4. 年齢別集計

### 契約者高齢者（70歳以上）
- **基本条件**: 受注件数の条件を満たし、G列の年齢 ≥ 70歳
- **過量販売**: K列に「過量」が含まれる場合
- **単独契約**: K列に「単独」が含まれる場合

### 契約者通常年齢（69歳以下）
- **基本条件**: 受注件数の条件を満たし、G列の年齢 ≤ 69歳
- **過量販売**: K列に「過量」が含まれる場合

## 5. 公休日・禁止日施工の集計

### 判定の流れ
受注1件に対し、以下の優先順位で判定：

#### ステップ1: T列（着工日）の判定
- T列の着工日が公休日または禁止日に該当する場合
- → 「公休日施工」または「禁止日施工」としてカウント
- → V列の判定は実行しない

#### ステップ2: V列（完工予定日）の判定
- T列でカウントされなかった案件のみ対象
- V列の完工予定日が公休日または禁止日に該当する場合
- → 「公休日施工」または「禁止日施工」としてカウント

### 重要事項
- **契約日（S列）は対象外**: 公休日・禁止日施工の集計に含まれない
- **重複カウント防止**: T列でカウントされた場合、V列は照合されない
- **受注条件必須**: 受注件数の条件を満たす案件のみが対象

## 6. 担当者別ランキング集計

### 基本条件
- 受注件数の条件を満たす案件のみ対象
- 対象期間のデータ（選択された月の1日〜末日）
- 担当者識別：地区№ + 所属№ + 担当者名の組み合わせ

### ランキング種類

#### ①契約者70歳以上の受注件数トップ10ランキング
- **対象**: G列の年齢 ≥ 70歳かつ受注条件を満たす案件
- **表示**: 1位〜10位（同件数は同順位、次順位は飛ばす）
- **出力**: PDF・CSV対象

#### ②単独契約を持っている担当者一覧
- **対象**: K列に「単独」が含まれる案件を持つ担当者
- **表示**: 1件以上の担当者すべて（件数降順）
- **出力**: PDF・CSV対象

#### ③過量契約を持っている担当者一覧
- **対象**: K列に「過量」が含まれる案件を持つ担当者
- **表示**: 1件以上の担当者すべて（件数降順）
- **出力**: PDF・CSV対象

#### ④69歳以下契約件数の担当別件数
- **対象**: G列の年齢 ≤ 69歳かつ受注条件を満たす案件
- **表示**: 全担当者（0件含む）を件数降順で表示
- **出力**: CSV対象のみ

### ランキング表示形式
すべてのランキングで以下の形式を使用：
```
ランキング | 地区No. | 所属No. | 担当名 | 件数
```

## 7. データ処理の流れ

### 1. ファイル読み込み
- Excelファイルの9行目以降をデータとして読み込み
- 各行を構造化データに変換

### 2. 基本判定処理
- `isOrder`: 受注条件の判定
- `isOvertime`: 時間外条件の判定
- `isSingle`: 単独契約の判定
- `isExcessive`: 過量販売の判定

### 3. 公休日・禁止日判定
- 設定された公休日・禁止日との照合
- T列、V列の優先順位に基づく判定

### 4. 集計処理
- 地区別、年齢別、担当者別の各種集計
- ランキング計算（同順位処理含む）

### 5. 出力処理
- HTML表示用データの生成
- PDF・CSV出力用データの整形

## 8. 技術仕様

### データ型変換
- **日付**: Excel形式 → JavaScript Date形式
- **時間**: Excel形式 → HH:MM形式
- **数値**: 文字列 → 数値変換（確認区分等）

### エラーハンドリング
- 不正なデータ形式の処理
- 空セル・null値の処理
- 型変換エラーの処理

### パフォーマンス考慮
- 大量データ処理時の最適化
- メモリ使用量の管理
- 処理時間の監視

## 9. 更新履歴

### 2025年1月 - 主要機能実装
- 基本的な日報・月報機能の実装
- 受注件数・時間外対応の判定ロジック確立
- 担当者別ランキング機能の追加
- 公休日・禁止日施工の集計機能追加
- データ確認・フィルタリング機能の実装
- PDF・CSV出力機能の実装

### 判定ロジックの修正
- 受注件数判定の動的日付対応
- 時間外判定の優先順位ロジック強化
- 単独契約・過量販売判定の正確性向上
- 月報タイトルの動的表示対応